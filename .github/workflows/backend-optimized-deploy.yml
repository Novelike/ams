name: AMS Backend Optimized Deployment

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ams-back/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - development

env:
  PYTHON_VERSION: '3.9'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (GitHub-hosted runner)
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('ams-back/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd ams-back
        pip install -r requirements.txt
        pip install flake8 pytest

    - name: Linting (flake8)
      run: |
        cd ams-back
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests
      run: |
        cd ams-back
        pytest tests/ -v || echo "No tests found"

  # ë°±ì—”ë“œ ë°°í¬ (Self-hosted Linux runner)
  deploy-backend:
    name: Deploy Backend
    runs-on: [self-hosted, linux, X64]
    needs: code-quality
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
    - name: Sync backend source
      run: |
        echo "ðŸš€ ë°±ì—”ë“œ ì†ŒìŠ¤ ë™ê¸°í™” ì‹œìž‘..."

        # ë°±ì—… ìƒì„±
        if [ -d "backup" ]; then
          rm -rf backup
        fi
        mkdir -p backup
        cp -r . backup/ 2>/dev/null || true

        # GitHubì—ì„œ ìµœì‹  ams-back ì†ŒìŠ¤ë§Œ ê°€ì ¸ì˜¤ê¸°
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3.raw" \
             -L "https://api.github.com/repos/${{ github.repository }}/tarball/${{ github.ref_name }}" \
             -o source.tar.gz

        # ìž„ì‹œ ë””ë ‰í† ë¦¬ì— ì••ì¶• í•´ì œ
        mkdir -p temp_source
        tar -xzf source.tar.gz -C temp_source --strip-components=1

        # ams-back ë‚´ìš©ë§Œ í˜„ìž¬ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
        if [ -d "temp_source/ams-back" ]; then
          rsync -av --delete --ignore-missing-args temp_source/ams-back/ ./ || {
            exit_code=$?
            if [ $exit_code -eq 24 ]; then
              echo "âš ï¸ rsync warning: some files vanished during transfer (exit code 24) - continuing deployment"
            else
              echo "âŒ rsync failed with exit code $exit_code"
              exit $exit_code
            fi
          }
        fi

        # ì •ë¦¬
        rm -rf temp_source source.tar.gz
        echo "âœ… ì†ŒìŠ¤ ë™ê¸°í™” ì™„ë£Œ"

    - name: Deploy application
      run: |
        echo "ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œìž‘..."

        # 1. ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
        if [ ! -d "venv" ]; then
          echo "ðŸ“¦ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
          python3 -m venv venv
        fi
        source venv/bin/activate

        # 2. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
        pip install -r requirements.txt

        # 3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        cat > .env << 'EOF'
        ENVIRONMENT=production
        PORT=8000
        ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5173,https://ams.novelike.dev,http://ams.novelike.dev
        PROD_SERVER_IP=10.0.3.203
        EOF

        # 4. ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
        sudo systemctl restart ams-backend
        sleep 5

        # 5. í—¬ìŠ¤ ì²´í¬
        for i in {1..10}; do
          if curl -f http://localhost:8000/api/health; then
            echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
            break
          fi
          if [ $i -eq 10 ]; then
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          sleep 3
        done

        echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"

    - name: Rollback on failure
      if: failure()
      run: |
        echo "ðŸ”„ ë¡¤ë°± ì‹œìž‘..."
        if [ -d "backup" ]; then
          rsync -av --delete --ignore-missing-args backup/ ./ || {
            exit_code=$?
            if [ $exit_code -eq 24 ]; then
              echo "âš ï¸ rsync warning during rollback: some files vanished during transfer (exit code 24) - continuing rollback"
            else
              echo "âŒ rsync rollback failed with exit code $exit_code"
              exit $exit_code
            fi
          }
          if [ ! -d "venv" ]; then
            echo "ðŸ“¦ ë¡¤ë°±ìš© ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
            python3 -m venv venv
          fi
          source venv/bin/activate
          sudo systemctl restart ams-backend
          echo "âœ… ë¡¤ë°± ì™„ë£Œ"
        fi

    - name: Cleanup
      if: always()
      run: |
        # ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬
        find . -name "backup*" -type d -mtime +7 -exec rm -rf {} + || true

  # ë°°í¬ í›„ ê²€ì¦
  post-deployment-check:
    name: Post Deployment Check
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: success()

    steps:
    - name: Health check
      run: |
        echo "ðŸ¥ ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬..."

        # ì™¸ë¶€ì—ì„œ API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
        for i in {1..5}; do
          if curl -f https://ams-api.novelike.dev/api/health; then
            echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          sleep 10
        done

    - name: API functionality test
      run: |
        echo "ðŸ§ª API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."

        # ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        response=$(curl -s https://ams-api.novelike.dev/)
        if echo "$response" | grep -q "Welcome to AMS API"; then
          echo "âœ… API ê¸°ë³¸ ê¸°ëŠ¥ ì •ìƒ"
        else
          echo "âŒ API ê¸°ë³¸ ê¸°ëŠ¥ ì˜¤ë¥˜"
          exit 1
        fi

  # ì•Œë¦¼
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, post-deployment-check]
    if: always()

    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.post-deployment-check.result }}" == "success" ]; then
          echo "ðŸŽ‰ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
          echo "Environment: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
        else
          echo "âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          echo "Deploy result: ${{ needs.deploy-backend.result }}"
          echo "Check result: ${{ needs.post-deployment-check.result }}"
        fi
