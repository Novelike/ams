name: AMS Backend Optimized Deployment

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ams-back/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - development

env:
  PYTHON_VERSION: '3.9'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (GitHub-hosted runner)
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('ams-back/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd ams-back
        pip install -r requirements.txt
        pip install flake8 pytest

    - name: Linting (flake8)
      run: |
        cd ams-back
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests
      run: |
        cd ams-back
        pytest tests/ -v || echo "No tests found"

  # ë°±ì—”ë“œ ë°°í¬ (Self-hosted Linux runner)
  deploy-backend:
    name: Deploy Backend
    runs-on: [self-hosted, linux, X64]
    needs: code-quality
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    # ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    defaults:
      run:
        working-directory: /home/ubuntu/ams-back

    steps:
      - name: Quick Pre-deployment Check
        run: |
          echo "âš¡ ë¹ ë¥¸ ë°°í¬ ì „ ì²´í¬..."

          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸ë§Œ (ì •ë¦¬ëŠ” í•„ìš”ì‹œì—ë§Œ)
          DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "í˜„ìž¬ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${DISK_USAGE}%"

          if [ $DISK_USAGE -gt 90 ]; then
            echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ 90% ì´ˆê³¼, ê¸´ê¸‰ ì •ë¦¬ ì‹¤í–‰..."
            pip cache purge || true
            rm -rf /tmp/pip-* /tmp/tmp* || true
            echo "âœ… ê¸´ê¸‰ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "âœ… ë””ìŠ¤í¬ ê³µê°„ ì¶©ë¶„, ì •ë¦¬ ê±´ë„ˆëœ€"
          fi

      - name: Ensure working directory exists
        run: |
          echo "ðŸ  ìž‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±..."
          mkdir -p /home/ubuntu/ams-back
          cd /home/ubuntu/ams-back
          echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la || echo "ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìžˆìŠµë‹ˆë‹¤"

      - name: Sync backend source (No Backup)
        run: |
          echo "ðŸš€ ë°±ì—”ë“œ ì†ŒìŠ¤ ë™ê¸°í™” ì‹œìž‘ (ë°±ì—… ì—†ì´ ë¹ ë¥¸ ë°°í¬)..."
          echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"

          # GitHubì—ì„œ ìµœì‹  ams-back ì†ŒìŠ¤ë§Œ ê°€ì ¸ì˜¤ê¸°
          echo "ðŸ“¥ GitHubì—ì„œ ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -L "https://api.github.com/repos/${{ github.repository }}/tarball/${{ github.ref_name }}" \
               -o source.tar.gz

          # ìž„ì‹œ ë””ë ‰í† ë¦¬ì— ì••ì¶• í•´ì œ
          echo "ðŸ“¦ ì†ŒìŠ¤ ì••ì¶• í•´ì œ ì¤‘..."
          mkdir -p temp_source
          tar -xzf source.tar.gz -C temp_source --strip-components=1

          # ams-back ë‚´ìš©ë§Œ í˜„ìž¬ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ (ë°±ì—… ì—†ì´)
          if [ -d "temp_source/ams-back" ]; then
            echo "ðŸ“ ams-back ì†ŒìŠ¤ ë³µì‚¬ ì¤‘..."
            # ì¤‘ìš” íŒŒì¼ë“¤ë§Œ ë³´ì¡´ (venv, .env)
            if [ -f ".env" ]; then
              cp .env .env.backup
            fi

            rsync -av --delete --ignore-missing-args \
              --exclude='venv/' \
              --exclude='.env' \
              temp_source/ams-back/ ./ || {
              exit_code=$?
              if [ $exit_code -eq 24 ]; then
                echo "âš ï¸ rsync warning: some files vanished during transfer (exit code 24) - continuing deployment"
              else
                echo "âŒ rsync failed with exit code $exit_code"
                exit $exit_code
              fi
            }

            # .env ë³µì›
            if [ -f ".env.backup" ]; then
              mv .env.backup .env
            fi
          else
            echo "âŒ temp_source/ams-back ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ë””ë ‰í† ë¦¬:"
            ls -la temp_source/
            exit 1
          fi

          # ì •ë¦¬
          rm -rf temp_source source.tar.gz

          # ê²°ê³¼ í™•ì¸
          echo "âœ… ì†ŒìŠ¤ ë™ê¸°í™” ì™„ë£Œ (ë°±ì—… ì—†ì´)"
          echo "requirements.txt ì¡´ìž¬ í™•ì¸:"
          if [ -f "requirements.txt" ]; then
            echo "âœ… requirements.txt íŒŒì¼ ì¡´ìž¬"
          else
            echo "âŒ requirements.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: Smart Dependencies Check
        run: |
          echo "ðŸ” ì˜ì¡´ì„± ë³€ê²½ í™•ì¸ ì¤‘..."

          # requirements.txt í™•ì¸
          if [ ! -f "requirements.txt" ]; then
            echo "âŒ requirements.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi

          # ê°€ìƒí™˜ê²½ ì¡´ìž¬ í™•ì¸
          if [ ! -d "venv" ]; then
            echo "ðŸ“¦ ê°€ìƒí™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
            echo "NEED_INSTALL=true" >> $GITHUB_ENV
          else
            echo "âœ… ê¸°ì¡´ ê°€ìƒí™˜ê²½ ë°œê²¬"

            # requirements.txt ë³€ê²½ í™•ì¸
            if [ -f "requirements.txt.last" ]; then
              if cmp -s requirements.txt requirements.txt.last; then
                echo "âœ… requirements.txt ë³€ê²½ ì—†ìŒ - ì˜ì¡´ì„± ì„¤ì¹˜ ê±´ë„ˆëœ€"
                echo "NEED_INSTALL=false" >> $GITHUB_ENV
              else
                echo "ðŸ“ requirements.txt ë³€ê²½ ê°ì§€ - ì˜ì¡´ì„± ìž¬ì„¤ì¹˜ í•„ìš”"
                echo "NEED_INSTALL=true" >> $GITHUB_ENV
              fi
            else
              echo "ðŸ“ ì²« ë°°í¬ ë˜ëŠ” ì´ì „ ê¸°ë¡ ì—†ìŒ - ì˜ì¡´ì„± ì„¤ì¹˜ í•„ìš”"
              echo "NEED_INSTALL=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies (Conditional)
        if: env.NEED_INSTALL == 'true'
        run: |
          echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œìž‘..."

          # ê°€ìƒí™˜ê²½ ìƒì„± ë˜ëŠ” ì •ë¦¬
          if [ ! -d "venv" ]; then
            echo "ðŸ”§ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
            python3 -m venv venv
          else
            echo "ðŸ”§ ê¸°ì¡´ ê°€ìƒí™˜ê²½ ì •ë¦¬ ì¤‘..."
            rm -rf venv
            python3 -m venv venv
          fi

          source venv/bin/activate

          # pip ì—…ê·¸ë ˆì´ë“œ ë° ì˜ì¡´ì„± ì„¤ì¹˜
          echo "â¬†ï¸ pip ì—…ê·¸ë ˆì´ë“œ ì¤‘..."
          pip install --upgrade pip --no-cache-dir

          echo "ðŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          pip install -r requirements.txt --no-cache-dir --no-warn-script-location

          # requirements.txt ë°±ì—… (ë‹¤ìŒ ë°°í¬ ì‹œ ë¹„êµìš©)
          cp requirements.txt requirements.txt.last

          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: Deploy Application (Fast)
        run: |
          echo "ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œìž‘ (ë¹ ë¥¸ ëª¨ë“œ)..."
          echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"

          # ê°€ìƒí™˜ê²½ í™œì„±í™”
          if [ ! -d "venv" ]; then
            echo "âŒ ê°€ìƒí™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤. ì´ì „ ë‹¨ê³„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          source venv/bin/activate

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          cat > .env << 'EOF'
          ENVIRONMENT=production
          PORT=8000
          ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5173,https://ams.novelike.dev,http://ams.novelike.dev
          PROD_SERVER_IP=10.0.3.203
          EOF

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          echo "ðŸ”„ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì¤‘..."
          sudo systemctl restart ams-backend
          sleep 3

          # ë¹ ë¥¸ í—¬ìŠ¤ ì²´í¬ (5íšŒë¡œ ë‹¨ì¶•)
          echo "ðŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          for i in {1..5}; do
            if curl -f http://localhost:8000/api/health; then
              echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ (${i}íšŒ ì‹œë„)"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (5íšŒ ì‹œë„ í›„)"
              exit 1
            fi
            echo "â³ í—¬ìŠ¤ ì²´í¬ ìž¬ì‹œë„ ì¤‘... (${i}/5)"
            sleep 2
          done

          echo "ðŸŽ‰ ë¹ ë¥¸ ë°°í¬ ì™„ë£Œ!"

      - name: Simple Rollback (Service Restart)
        if: failure()
        run: |
          echo "ðŸ”„ ê°„ë‹¨ ë¡¤ë°± ì‹œìž‘ (ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘)..."

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ðŸ“Š í˜„ìž¬ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl status ams-backend --no-pager || true

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì‹œë„
          echo "ðŸ”„ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì¤‘..."
          sudo systemctl restart ams-backend
          sleep 3

          # ê°„ë‹¨í•œ í—¬ìŠ¤ ì²´í¬
          echo "ðŸ¥ ë¡¤ë°± í›„ í—¬ìŠ¤ ì²´í¬..."
          for i in {1..3}; do
            if curl -f http://localhost:8000/api/health; then
              echo "âœ… ë¡¤ë°± í›„ ì„œë¹„ìŠ¤ ì •ìƒ (${i}íšŒ ì‹œë„)"
              break
            fi
            if [ $i -eq 3 ]; then
              echo "âŒ ë¡¤ë°± í›„ì—ë„ ì„œë¹„ìŠ¤ ë¬¸ì œ ì§€ì†"
              echo "ðŸ“‹ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸:"
              sudo journalctl -u ams-backend --since "5 minutes ago" --no-pager | tail -20
            fi
            sleep 2
          done

          echo "âœ… ê°„ë‹¨ ë¡¤ë°± ì™„ë£Œ"

      - name: Quick Post-deployment Summary
        if: always()
        run: |
          echo "ðŸ“Š ë°°í¬ ì™„ë£Œ ìš”ì•½..."

          # ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ë§Œ í™•ì¸
          DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${DISK_USAGE}%"

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl is-active ams-backend || echo "ì„œë¹„ìŠ¤ ë¹„í™œì„±"

          echo "âœ… ë¹ ë¥¸ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"

  # ë°°í¬ í›„ ê²€ì¦
  post-deployment-check:
    name: Post Deployment Check
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: success()

    steps:
    - name: Health check
      run: |
        echo "ðŸ¥ ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬..."

        # ì™¸ë¶€ì—ì„œ API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
        for i in {1..5}; do
          if curl -f https://ams-api.novelike.dev/api/health; then
            echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          sleep 10
        done

    - name: API functionality test
      run: |
        echo "ðŸ§ª API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."

        # ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        response=$(curl -s https://ams-api.novelike.dev/)
        if echo "$response" | grep -q "Welcome to AMS API"; then
          echo "âœ… API ê¸°ë³¸ ê¸°ëŠ¥ ì •ìƒ"
        else
          echo "âŒ API ê¸°ë³¸ ê¸°ëŠ¥ ì˜¤ë¥˜"
          exit 1
        fi

  # ì•Œë¦¼
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, post-deployment-check]
    if: always()

    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.post-deployment-check.result }}" == "success" ]; then
          echo "ðŸŽ‰ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
          echo "Environment: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
        else
          echo "âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          echo "Deploy result: ${{ needs.deploy-backend.result }}"
          echo "Check result: ${{ needs.post-deployment-check.result }}"
        fi
